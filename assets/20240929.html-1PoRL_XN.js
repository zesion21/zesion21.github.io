import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as s,o as a,b as n}from"./app-CFuNIExP.js";const t="/assets/image-BYgPDbho.png",h="/assets/image-1-yJ4W6GZB.png",l={},k=n(`<h1 id="搭建简易-koa-并对接微信自动回复" tabindex="-1"><a class="header-anchor" href="#搭建简易-koa-并对接微信自动回复"><span>搭建简易 Koa 并对接微信自动回复</span></a></h1><h3 id="_0-前言" tabindex="-1"><a class="header-anchor" href="#_0-前言"><span>0.前言</span></a></h3><p>因最近想做一个公众号的自动回复功能，便有了这篇文章。至于后台 server 的选择，做一个小的 server 就行，便没有必要用 Midway，便手写一个简单的 koa。</p><h3 id="_1-搭建后台-server" tabindex="-1"><a class="header-anchor" href="#_1-搭建后台-server"><span>1.搭建后台 server</span></a></h3><div class="language-ts line-numbers-mode" data-highlighter="shiki" data-ext="ts" data-title="ts" style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;--shiki-dark-bg:#272822;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes monokai one-light vp-code"><code><span class="line"><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">import</span><span style="--shiki-dark:#AE81FF;--shiki-light:#E45649;"> *</span><span style="--shiki-dark:#F92672;--shiki-light:#383A42;"> as</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;"> Koa</span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;"> from</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;"> &quot;koa&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;"> koa</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;"> require</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;koa&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;"> bodyParser</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;"> require</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;koa-bodyparser&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">import</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> { </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">wx</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> } </span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">from</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;"> &quot;./routes&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">; </span><span style="--shiki-dark:#88846F;--shiki-light:#A0A1A7;--shiki-dark-font-style:inherit;--shiki-light-font-style:italic;">//路由</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;"> app</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;">:</span><span style="--shiki-dark:#A6E22E;--shiki-light:#C18401;--shiki-dark-text-decoration:underline;--shiki-light-text-decoration:inherit;"> Koa</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;"> new</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;"> koa</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">app.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">use</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">bodyParser</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">());</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">app.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">use</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(wx.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">routes</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">());</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">app.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">use</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(wx.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">allowedMethods</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">app.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">listen</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#AE81FF;--shiki-light:#986801;">3306</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, () </span><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">=&gt;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> console.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">log</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">\`server is listen:3306\`</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-编写路由" tabindex="-1"><a class="header-anchor" href="#_2-编写路由"><span>2.编写路由</span></a></h3><div class="language-ts line-numbers-mode" data-highlighter="shiki" data-ext="ts" data-title="ts" style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;--shiki-dark-bg:#272822;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes monokai one-light vp-code"><code><span class="line"><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">import</span><span style="--shiki-dark:#AE81FF;--shiki-light:#E45649;"> *</span><span style="--shiki-dark:#F92672;--shiki-light:#383A42;"> as</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;"> koaRouter</span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;"> from</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;"> &quot;koa-router&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;"> koa_router</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;"> require</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;koa-router&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;"> wx</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;">:</span><span style="--shiki-dark:#A6E22E;--shiki-light:#C18401;--shiki-dark-text-decoration:underline;--shiki-light-text-decoration:inherit;"> koaRouter</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;"> new</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;"> koa_router</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">wx.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">prefix</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;/wx&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">wx.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">get</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;/recive.json&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">async</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#FD971F;--shiki-light:#383A42;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">ctx</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#FD971F;--shiki-light:#383A42;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">next</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">) </span><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">=&gt;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> {</span></span>
<span class="line"><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">  await</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;"> next</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">();</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  console.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">log</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;GET请求&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">wx.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">post</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;/recive.json&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">async</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#FD971F;--shiki-light:#383A42;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">ctx</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#FD971F;--shiki-light:#383A42;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">next</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">) </span><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">=&gt;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> {</span></span>
<span class="line"><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">  await</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;"> next</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">();</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  console.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">log</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;Post请求&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">export</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> { </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">wx</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> };</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>* 这里的地址必须是<code>.json</code>结尾，否则收不到微信发送过来的请求</p><h3 id="_3-添加功能代码" tabindex="-1"><a class="header-anchor" href="#_3-添加功能代码"><span>3.添加功能代码</span></a></h3><div class="language-ts line-numbers-mode" data-highlighter="shiki" data-ext="ts" data-title="ts" style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;--shiki-dark-bg:#272822;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes monokai one-light vp-code"><code><span class="line"><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">import</span><span style="--shiki-dark:#AE81FF;--shiki-light:#E45649;"> *</span><span style="--shiki-dark:#F92672;--shiki-light:#383A42;"> as</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;"> koaRouter</span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;"> from</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;"> &quot;koa-router&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;"> koa_router</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;"> require</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;koa-router&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;"> wx</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;">:</span><span style="--shiki-dark:#A6E22E;--shiki-light:#C18401;--shiki-dark-text-decoration:underline;--shiki-light-text-decoration:inherit;"> koaRouter</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;"> new</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;"> koa_router</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">();</span></span>
<span class="line"><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">import</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> { </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">SHA1</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> } </span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">from</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;"> &quot;crypto-js&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">import</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> { </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">parseStringPromise</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> } </span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">from</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;"> &quot;xml2js&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">wx.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">prefix</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;/wx&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#88846F;--shiki-light:#A0A1A7;--shiki-dark-font-style:inherit;--shiki-light-font-style:italic;">// get请求用来对接时验证</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">wx.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">get</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;/recive.json&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">async</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#FD971F;--shiki-light:#383A42;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">ctx</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#FD971F;--shiki-light:#383A42;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">next</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">) </span><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">=&gt;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> {</span></span>
<span class="line"><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">  await</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;"> next</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">();</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  console.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">log</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;GET请求&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">  const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> { </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;">signature</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;">echostr</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;">timestamp</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;">nonce</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> } </span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;">=</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> ctx.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">request</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">query</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">  const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;"> token</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;"> &quot;[token]&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">; </span><span style="--shiki-dark:#88846F;--shiki-light:#A0A1A7;--shiki-dark-font-style:inherit;--shiki-light-font-style:italic;">//自己设置一个token，后边在公众号平台配置</span></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">  const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;"> arr</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> [token, timestamp, nonce];</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  arr.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">sort</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">();</span></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">  const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;"> s</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> arr.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">join</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">().</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">replace</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#0184BC;">/</span><span style="--shiki-dark:#AE81FF;--shiki-light:#0184BC;">\\,</span><span style="--shiki-dark:#E6DB74;--shiki-light:#0184BC;">/</span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">g</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">  if</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">SHA1</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(s).</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">toString</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">() </span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;">==</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> signature) {</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">    ctx.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">response</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">body</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> echostr;</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">    ctx.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">status</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#AE81FF;--shiki-light:#986801;"> 200</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  } </span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">else</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> {</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">    ctx.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">body</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> { </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">code</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#0184BC;">:</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> -</span><span style="--shiki-dark:#AE81FF;--shiki-light:#986801;">1</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">msg</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#0184BC;">:</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;"> &quot;fail&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> };</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">    ctx.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">status</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#AE81FF;--shiki-light:#986801;"> 500</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  }</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">});</span></span>
<span class="line"><span style="--shiki-dark:#88846F;--shiki-light:#A0A1A7;--shiki-dark-font-style:inherit;--shiki-light-font-style:italic;">// Post请求用来处理收到的消息</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">wx.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">post</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;/recive.json&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">async</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#FD971F;--shiki-light:#383A42;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">ctx</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#FD971F;--shiki-light:#383A42;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">next</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">) </span><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">=&gt;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> {</span></span>
<span class="line"><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">  await</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;"> next</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">();</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  console.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">log</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;Post请求&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  ctx.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">req</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">setEncoding</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;utf-8&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">  let</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> xml </span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;">=</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;"> &quot;&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  ctx.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">req</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">on</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;data&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">async</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> (</span><span style="--shiki-dark:#FD971F;--shiki-light:#383A42;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">x</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">) </span><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">=&gt;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> {</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">    xml </span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;">+=</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> x;</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  });</span></span>
<span class="line"><span style="--shiki-dark:#88846F;--shiki-light:#A0A1A7;--shiki-dark-font-style:inherit;--shiki-light-font-style:italic;">  //   xml转json</span></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">  const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> { </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;">ToUserName</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;">FromUserName</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;">Content</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> } </span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;">=</span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;"> await</span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;"> new</span><span style="--shiki-dark:#66D9EF;--shiki-light:#C18401;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;"> Promise</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">&lt;</span><span style="--shiki-dark:#66D9EF;--shiki-light:#383A42;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">any</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">&gt;(</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">    (</span><span style="--shiki-dark:#FD971F;--shiki-light:#383A42;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">resolve</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">) </span><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">=&gt;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> {</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">      ctx.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">req</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">on</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;end&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">async</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> () </span><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">=&gt;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> {</span></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">        const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;"> data</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;"> await</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;"> parseStringPromise</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(xml);</span></span>
<span class="line"><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">        resolve</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(data.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">xml</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">      });</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">    }</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit;">  const</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#986801;"> resMsg</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;"> &quot;&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  ctx.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">status</span><span style="--shiki-dark:#F92672;--shiki-light:#0184BC;"> =</span><span style="--shiki-dark:#AE81FF;--shiki-light:#986801;"> 200</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">;</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  ctx.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">res</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">setHeader</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;Content-Type&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">, </span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&quot;application/xml&quot;</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#88846F;--shiki-light:#A0A1A7;--shiki-dark-font-style:inherit;--shiki-light-font-style:italic;">  //   这里只演示了回复文字，具体参考： https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Passive_user_reply_message.html</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">  ctx.</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">res</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">end</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">\`&lt;xml&gt;</span></span>
<span class="line"><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">      &lt;ToUserName&gt;&lt;![CDATA[</span><span style="--shiki-dark:#F92672;--shiki-light:#CA1243;">\${</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">FromUserName[</span><span style="--shiki-dark:#AE81FF;--shiki-light:#986801;">0</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">]</span><span style="--shiki-dark:#F92672;--shiki-light:#CA1243;">}</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">]]&gt;&lt;/ToUserName&gt;</span></span>
<span class="line"><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">      &lt;FromUserName&gt;&lt;![CDATA[</span><span style="--shiki-dark:#F92672;--shiki-light:#CA1243;">\${</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">ToUserName[</span><span style="--shiki-dark:#AE81FF;--shiki-light:#986801;">0</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">]</span><span style="--shiki-dark:#F92672;--shiki-light:#CA1243;">}</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">]]&gt;&lt;/FromUserName&gt;</span></span>
<span class="line"><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">      &lt;CreateTime&gt;</span><span style="--shiki-dark:#F92672;--shiki-light:#CA1243;">\${</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">Date</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#50A14F;">.</span><span style="--shiki-dark:#A6E22E;--shiki-light:#4078F2;">now</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">()</span><span style="--shiki-dark:#F92672;--shiki-light:#CA1243;">}</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">&lt;/CreateTime&gt;</span></span>
<span class="line"><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">      &lt;MsgType&gt;&lt;![CDATA[text]]&gt;&lt;/MsgType&gt;</span></span>
<span class="line"><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">      &lt;Content&gt;&lt;![CDATA[</span><span style="--shiki-dark:#F92672;--shiki-light:#CA1243;">\${</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">resMsg</span><span style="--shiki-dark:#F92672;--shiki-light:#CA1243;">}</span><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">]]&gt;&lt;/Content&gt;</span></span>
<span class="line"><span style="--shiki-dark:#E6DB74;--shiki-light:#50A14F;">    &lt;/xml&gt;\`</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">);</span></span>
<span class="line"><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#F92672;--shiki-light:#A626A4;">export</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> { </span><span style="--shiki-dark:#F8F8F2;--shiki-light:#E45649;">wx</span><span style="--shiki-dark:#F8F8F2;--shiki-light:#383A42;"> };</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-公网地址配置" tabindex="-1"><a class="header-anchor" href="#_4-公网地址配置"><span>4.公网地址配置</span></a></h3><p>因为微信服务器需要通过公网来与我们的服务器进行交互，所以我们需要有一个公网地址。（有公网 ip 或者域名的跳过此步）</p><ul><li>使用花生壳（https://hsk.oray.com/） <ol><li>下载安装花生壳客户端</li><li>配置映射 <img src="`+t+'" alt="配置映射" loading="lazy"></li></ol></li></ul><h3 id="_5-微信公众号平台配置" tabindex="-1"><a class="header-anchor" href="#_5-微信公众号平台配置"><span>5.微信公众号平台配置</span></a></h3><figure><img src="'+h+'" alt="微信公众号平台配置" tabindex="0" loading="lazy"><figcaption>微信公众号平台配置</figcaption></figure><p><strong>参考</strong></p><blockquote><p><a href="https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html" target="_blank" rel="noopener noreferrer">微信官方文档</a></p></blockquote>',17),e=[k];function p(F,r){return a(),s("div",null,e)}const y=i(l,[["render",p],["__file","20240929.html.vue"]]),A=JSON.parse('{"path":"/article/node/2024/20240929.html","title":"搭建简易 Koa 并对接微信自动回复","lang":"zh-CN","frontmatter":{"date":"2024-09-27T00:00:00.000Z","tag":["node","server"],"categories":["Node"],"description":"搭建简易 Koa 并对接微信自动回复 0.前言 因最近想做一个公众号的自动回复功能，便有了这篇文章。至于后台 server 的选择，做一个小的 server 就行，便没有必要用 Midway，便手写一个简单的 koa。 1.搭建后台 server 2.编写路由 * 这里的地址必须是.json结尾，否则收不到微信发送过来的请求 3.添加功能代码 4.公网...","head":[["meta",{"property":"og:url","content":"http://zesionlee.cn/article/node/2024/20240929.html"}],["meta",{"property":"og:site_name","content":"全栈笔记"}],["meta",{"property":"og:title","content":"搭建简易 Koa 并对接微信自动回复"}],["meta",{"property":"og:description","content":"搭建简易 Koa 并对接微信自动回复 0.前言 因最近想做一个公众号的自动回复功能，便有了这篇文章。至于后台 server 的选择，做一个小的 server 就行，便没有必要用 Midway，便手写一个简单的 koa。 1.搭建后台 server 2.编写路由 * 这里的地址必须是.json结尾，否则收不到微信发送过来的请求 3.添加功能代码 4.公网..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-09-29T03:33:32.000Z"}],["meta",{"property":"article:author","content":"阿琛"}],["meta",{"property":"article:tag","content":"node"}],["meta",{"property":"article:tag","content":"server"}],["meta",{"property":"article:published_time","content":"2024-09-27T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-09-29T03:33:32.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"搭建简易 Koa 并对接微信自动回复\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2024-09-27T00:00:00.000Z\\",\\"dateModified\\":\\"2024-09-29T03:33:32.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"阿琛\\",\\"url\\":\\"http://zesionlee.cn\\"}]}"]]},"headers":[{"level":3,"title":"0.前言","slug":"_0-前言","link":"#_0-前言","children":[]},{"level":3,"title":"1.搭建后台 server","slug":"_1-搭建后台-server","link":"#_1-搭建后台-server","children":[]},{"level":3,"title":"2.编写路由","slug":"_2-编写路由","link":"#_2-编写路由","children":[]},{"level":3,"title":"3.添加功能代码","slug":"_3-添加功能代码","link":"#_3-添加功能代码","children":[]},{"level":3,"title":"4.公网地址配置","slug":"_4-公网地址配置","link":"#_4-公网地址配置","children":[]},{"level":3,"title":"5.微信公众号平台配置","slug":"_5-微信公众号平台配置","link":"#_5-微信公众号平台配置","children":[]}],"git":{"createdTime":1727580812000,"updatedTime":1727580812000,"contributors":[{"name":"zesionlee","email":"39211025+zesion21@users.noreply.github.com","commits":1}]},"readingTime":{"minutes":1.8,"words":540},"filePathRelative":"article/node/2024/20240929.md","localizedDate":"2024年9月27日","excerpt":"\\n<h3>0.前言</h3>\\n<p>因最近想做一个公众号的自动回复功能，便有了这篇文章。至于后台 server 的选择，做一个小的 server 就行，便没有必要用 Midway，便手写一个简单的 koa。</p>\\n<h3>1.搭建后台 server</h3>\\n<div class=\\"language-ts line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"ts\\" data-title=\\"ts\\" style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42;--shiki-dark-bg:#272822;--shiki-light-bg:#FAFAFA\\"><pre class=\\"shiki shiki-themes monokai one-light vp-code\\"><code><span class=\\"line\\"><span style=\\"--shiki-dark:#F92672;--shiki-light:#A626A4\\">import</span><span style=\\"--shiki-dark:#AE81FF;--shiki-light:#E45649\\"> *</span><span style=\\"--shiki-dark:#F92672;--shiki-light:#383A42\\"> as</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#E45649\\"> Koa</span><span style=\\"--shiki-dark:#F92672;--shiki-light:#A626A4\\"> from</span><span style=\\"--shiki-dark:#E6DB74;--shiki-light:#50A14F\\"> \\"koa\\"</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit\\">const</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#986801\\"> koa</span><span style=\\"--shiki-dark:#F92672;--shiki-light:#0184BC\\"> =</span><span style=\\"--shiki-dark:#A6E22E;--shiki-light:#4078F2\\"> require</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">(</span><span style=\\"--shiki-dark:#E6DB74;--shiki-light:#50A14F\\">\\"koa\\"</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">);</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit\\">const</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#986801\\"> bodyParser</span><span style=\\"--shiki-dark:#F92672;--shiki-light:#0184BC\\"> =</span><span style=\\"--shiki-dark:#A6E22E;--shiki-light:#4078F2\\"> require</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">(</span><span style=\\"--shiki-dark:#E6DB74;--shiki-light:#50A14F\\">\\"koa-bodyparser\\"</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">);</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-dark:#F92672;--shiki-light:#A626A4\\">import</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\"> { </span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#E45649\\">wx</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\"> } </span><span style=\\"--shiki-dark:#F92672;--shiki-light:#A626A4\\">from</span><span style=\\"--shiki-dark:#E6DB74;--shiki-light:#50A14F\\"> \\"./routes\\"</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">; </span><span style=\\"--shiki-dark:#88846F;--shiki-light:#A0A1A7;--shiki-dark-font-style:inherit;--shiki-light-font-style:italic\\">//路由</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit\\">const</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#986801\\"> app</span><span style=\\"--shiki-dark:#F92672;--shiki-light:#0184BC\\">:</span><span style=\\"--shiki-dark:#A6E22E;--shiki-light:#C18401;--shiki-dark-text-decoration:underline;--shiki-light-text-decoration:inherit\\"> Koa</span><span style=\\"--shiki-dark:#F92672;--shiki-light:#0184BC\\"> =</span><span style=\\"--shiki-dark:#F92672;--shiki-light:#A626A4\\"> new</span><span style=\\"--shiki-dark:#A6E22E;--shiki-light:#4078F2\\"> koa</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">();</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">app.</span><span style=\\"--shiki-dark:#A6E22E;--shiki-light:#4078F2\\">use</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">(</span><span style=\\"--shiki-dark:#A6E22E;--shiki-light:#4078F2\\">bodyParser</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">());</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">app.</span><span style=\\"--shiki-dark:#A6E22E;--shiki-light:#4078F2\\">use</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">(wx.</span><span style=\\"--shiki-dark:#A6E22E;--shiki-light:#4078F2\\">routes</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">());</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">app.</span><span style=\\"--shiki-dark:#A6E22E;--shiki-light:#4078F2\\">use</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">(wx.</span><span style=\\"--shiki-dark:#A6E22E;--shiki-light:#4078F2\\">allowedMethods</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">());</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">app.</span><span style=\\"--shiki-dark:#A6E22E;--shiki-light:#4078F2\\">listen</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">(</span><span style=\\"--shiki-dark:#AE81FF;--shiki-light:#986801\\">3306</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">, () </span><span style=\\"--shiki-dark:#66D9EF;--shiki-light:#A626A4;--shiki-dark-font-style:italic;--shiki-light-font-style:inherit\\">=&gt;</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\"> console.</span><span style=\\"--shiki-dark:#A6E22E;--shiki-light:#4078F2\\">log</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">(</span><span style=\\"--shiki-dark:#E6DB74;--shiki-light:#50A14F\\">`server is listen:3306`</span><span style=\\"--shiki-dark:#F8F8F2;--shiki-light:#383A42\\">));</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{y as comp,A as data};
